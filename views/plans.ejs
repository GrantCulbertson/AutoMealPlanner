<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/public/styles.css" rel="stylesheet">
</head>
<body class="bg-body">
  <nav class="navbar navbar-expand-lg navbar-dark bg-darkgray mb-4">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/">AutoMeal Planner</a>
      <div>
        <a class="btn btn-outline-light me-2" href="/">New Plan</a>
        <a class="btn btn-outline-light me-2" href="/profile">Profile</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-12 col-xl-10">
        <h3 class="mb-3">Your Weekly Grocery Lists & Meal Plans</h3>
        <% if (message) { %>
          <div class="alert alert-success"><%= message %></div>
        <% } %>
        <% if (error) { %>
          <div class="alert alert-danger"><%= error %></div>
        <% } %>
        <% if (!plans || plans.length === 0) { %>
          <div class="alert alert-info">No plans yet. Create one from the home page.</div>
        <% } %>

        <% plans.forEach(function(p) { %>
          <div class="card shadow-sm mb-4">
            <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
              <div>
                <span class="badge bg-sage me-2">Generated</span>
                <strong><%= new Date(p.createdAt).toLocaleString() %></strong>
              </div>
              <div class="text-muted small">
                Budget: $<%= p.input.weeklyBudgetUsd %> · Store: <%= p.input.groceryStore %> · Complexity: <%= p.input.complexity %>
              </div>
            </div>
            <div class="card-body">
              <div class="row g-4">
                <div class="col-md-5">
                  <h5>Grocery List</h5>
                  <% 
                    // Group groceries by category
                    const groceryCategories = {
                      'Produce': [],
                      'Meat & Seafood': [],
                      'Dairy & Eggs': [],
                      'Pantry & Staples': [],
                      'Frozen': [],
                      'Bakery': [],
                      'Other': []
                    };
                    
                    (p.plan.grocery_list || []).forEach(function(item) {
                      if (typeof item === 'string') {
                        groceryCategories['Other'].push({ name: item, quantity: '', cost: '--' });
                      } else {
                        const itemName = (item.item || item.name || '').toLowerCase();
                        let category = 'Other';
                        
                        // Categorize items based on common patterns
                        if (itemName.includes('chicken') || itemName.includes('beef') || itemName.includes('pork') || 
                            itemName.includes('turkey') || itemName.includes('salmon') || itemName.includes('fish') ||
                            itemName.includes('meat') || itemName.includes('bacon') || itemName.includes('sausage')) {
                          category = 'Meat & Seafood';
                        } else if (itemName.includes('milk') || itemName.includes('cheese') || itemName.includes('yogurt') ||
                                   itemName.includes('butter') || itemName.includes('cream') || itemName.includes('eggs') ||
                                   itemName.includes('dairy')) {
                          category = 'Dairy & Eggs';
                        } else if (itemName.includes('apple') || itemName.includes('banana') || itemName.includes('orange') ||
                                   itemName.includes('tomato') || itemName.includes('onion') || itemName.includes('garlic') ||
                                   itemName.includes('pepper') || itemName.includes('carrot') || itemName.includes('broccoli') ||
                                   itemName.includes('spinach') || itemName.includes('lettuce') || itemName.includes('cucumber') ||
                                   itemName.includes('avocado') || itemName.includes('lime') || itemName.includes('lemon') ||
                                   itemName.includes('cilantro') || itemName.includes('herb') || itemName.includes('vegetable') ||
                                   itemName.includes('fruit') || itemName.includes('produce')) {
                          category = 'Produce';
                        } else if (itemName.includes('bread') || itemName.includes('tortilla') || itemName.includes('pasta') ||
                                   itemName.includes('rice') || itemName.includes('oats') || itemName.includes('flour') ||
                                   itemName.includes('cereal') || itemName.includes('cracker') || itemName.includes('bun')) {
                          category = 'Pantry & Staples';
                        } else if (itemName.includes('frozen') || itemName.includes('ice cream')) {
                          category = 'Frozen';
                        } else if (itemName.includes('bread') || itemName.includes('bagel') || itemName.includes('muffin') ||
                                   itemName.includes('croissant')) {
                          category = 'Bakery';
                        }
                        
                        groceryCategories[category].push({
                          name: item.item || item.name,
                          quantity: item.quantity || '',
                          cost: item.estimatedCost || '--'
                        });
                      }
                    });
                  %>
                  
                  <% Object.keys(groceryCategories).forEach(function(category) { %>
                    <% if (groceryCategories[category].length > 0) { %>
                      <div class="grocery-category mb-3">
                        <h6 class="text-muted mb-2"><%= category %></h6>
                        <ul class="list-group list-group-flush">
                          <% groceryCategories[category].forEach(function(item) { %>
                            <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                              <span><%= item.name %></span>
                              <div class="d-flex align-items-center">
                                <% if (item.quantity) { %>
                                  <span class="badge bg-secondary me-2"><%= item.quantity %></span>
                                <% } %>
                                <span class="badge bg-darkgray">$<%= item.cost %></span>
                              </div>
                            </li>
                          <% }) %>
                        </ul>
                      </div>
                    <% } %>
                  <% }) %>
                  <% if (p.plan.totalEstimatedCost) { %>
                    <div class="mt-3 p-3 bg-light rounded">
                      <div class="d-flex justify-content-between align-items-center">
                        <strong>Total Estimated Cost:</strong>
                        <span class="h5 text-success mb-0">$<%= p.plan.totalEstimatedCost %></span>
                      </div>
                      <small class="text-muted">Based on <%= p.input.groceryStore %> prices in <%= p.input.location %></small>
                    </div>
                  <% } %>
                </div>
                <div class="col-md-7">
                  <h5>Weekly Plan</h5>
                  <div class="accordion" id="accordion<%= p.id %>">
                    <% (p.plan.weekly_plan || []).forEach(function(day, idx) { %>
                      <div class="accordion-item">
                        <h2 class="accordion-header" id="heading<%= p.id %>_<%= idx %>">
                          <button class="accordion-button <%= idx !== 0 ? 'collapsed' : '' %>" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= p.id %>_<%= idx %>" aria-expanded="<%= idx === 0 ? 'true' : 'false' %>" aria-controls="collapse<%= p.id %>_<%= idx %>">
                            <%= day.day || ('Day ' + (idx + 1)) %>
                          </button>
                        </h2>
                        <div id="collapse<%= p.id %>_<%= idx %>" class="accordion-collapse collapse <%= idx === 0 ? 'show' : '' %>" aria-labelledby="heading<%= p.id %>_<%= idx %>" data-bs-parent="#accordion<%= p.id %>">
                          <div class="accordion-body">
                            <div class="row">
                              <% if (day.meals && Array.isArray(day.meals)) { %>
                                <% 
                                  const mealTypes = p.input.selectedMealTypes || ['breakfast', 'lunch', 'dinner'];
                                  const colClass = mealTypes.length === 1 ? 'col-12' : mealTypes.length === 2 ? 'col-md-6' : 'col-md-4';
                                %>
                                <% day.meals.forEach(function(meal, mealIndex) { %>
                                  <div class="<%= colClass %>">
                                    <div class="meal">
                                      <div class="meal-label">
                                        <% 
                                          const mealType = mealTypes[mealIndex] || 'meal';
                                        %>
                                        <%= mealType.charAt(0).toUpperCase() + mealType.slice(1) %>
                                      </div>
                                      <div class="meal-title"><%= meal.title %></div>
                                      <% if (meal.category) { %>
                                        <div class="meal-category">
                                          <span class="badge bg-primary"><%= meal.category %></span>
                                        </div>
                                      <% } %>
                                      <div class="meal-desc"><%= meal.instructions %></div>
                                      <% if (meal.recipeLink) { %>
                                        <div class="meal-link mt-2">
                                          <a href="<%= meal.recipeLink %>" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-link-45deg"></i> View Recipe
                                          </a>
                                        </div>
                                      <% } %>
                                    </div>
                                  </div>
                                <% }) %>
                              <% } else { %>
                                <!-- Fallback for old format -->
                                <div class="col-md-4">
                                  <div class="meal">
                                    <div class="meal-label">Breakfast</div>
                                    <% if (day.meals && day.meals.breakfast) { %>
                                      <div class="meal-desc"><%= day.meals.breakfast %></div>
                                    <% } else if (day.breakfast) { %>
                                      <div class="meal-title"><%= day.breakfast.title %></div>
                                      <div class="meal-desc"><%= day.breakfast.instructions %></div>
                                    <% } %>
                                  </div>
                                </div>
                                <div class="col-md-4">
                                  <div class="meal">
                                    <div class="meal-label">Lunch</div>
                                    <% if (day.meals && day.meals.lunch) { %>
                                      <div class="meal-desc"><%= day.meals.lunch %></div>
                                    <% } else if (day.lunch) { %>
                                      <div class="meal-title"><%= day.lunch.title %></div>
                                      <div class="meal-desc"><%= day.lunch.instructions %></div>
                                    <% } %>
                                  </div>
                                </div>
                                <div class="col-md-4">
                                  <div class="meal">
                                    <div class="meal-label">Dinner</div>
                                    <% if (day.meals && day.meals.dinner) { %>
                                      <div class="meal-desc"><%= day.meals.dinner %></div>
                                    <% } else if (day.dinner) { %>
                                      <div class="meal-title"><%= day.dinner.title %></div>
                                      <div class="meal-desc"><%= day.dinner.instructions %></div>
                                    <% } %>
                                  </div>
                                </div>
                              <% } %>
                            </div>
                          </div>
                        </div>
                      </div>
                    <% }) %>
                  </div>
                </div>
              </div>
              <div class="card-footer bg-light">
                <form action="/delete-plan/<%= p.id %>" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this meal plan?')">
                  <button type="submit" class="btn btn-outline-danger btn-sm">
                    <i class="bi bi-trash"></i> Delete Meal Plan
                  </button>
                </form>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    </div>
  </div>

  <footer class="text-center mt-5 mb-4 text-muted small">
    Built with ❤️ using Node.js, Express, and EJS
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

